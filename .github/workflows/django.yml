name: Django CI-CD Pipeline

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # ---------------------------------------------------------
  # Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù€ CI (Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ø³Ù„ÙŠÙ…)
  # ---------------------------------------------------------
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Ø®Ø·ÙˆØ© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env ÙˆÙ‡Ù…ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ø¯ÙˆÙƒØ±
      - name: Create stub .env file
        working-directory: ./invoice_sys
        run: |
          echo "POSTGRES_DB=test_db" >> .env
          echo "POSTGRES_USER=test_user" >> .env
          echo "POSTGRES_PASSWORD=test_pass" >> .env
          echo "SECRET_KEY=test_secret_key" >> .env
          echo "DEBUG=True" >> .env

      - name: Build and Start Containers
        working-directory: ./invoice_sys
        run: |
          docker compose -f docker-compose.dev.yml up --build -d

      - name: Wait for services
        run: sleep 15

      - name: Run Pytest
        working-directory: ./invoice_sys
        run: |
          docker compose -f docker-compose.dev.yml exec -T web pytest

  # ---------------------------------------------------------
  # Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù€ CD (Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ± - Ø¯ÙŠÙ…Ùˆ ØªØ¹Ù„ÙŠÙ…ÙŠ)
  # ---------------------------------------------------------
  deploy:
    needs: test  # Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ø§ Ù„Ùˆ Ù†Ø¬Ø­Øª Ø§Ù„ØªØ³ØªØ§Øª 100%
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Ø§Ù„Ù†Ø´Ø± ÙŠØªÙ… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    
    steps:
      - name: Simulation of Production Deployment
        run: |
          echo "ğŸš€ Starting Deployment process..."
          echo "Step 1: Connecting to Production Server via SSH..."
          echo "Step 2: Running 'git pull origin main' on server..."
          echo "Step 3: Rebuilding Docker images: 'docker compose up -d --build'"
          echo "Step 4: Running database migrations on production..."
          echo "âœ… SUCCESS: App version ${{ github.sha }} is now LIVE!"

      - name: Post-Deployment Health Check
        run: echo "Sending request to https://your-app-demo.com/health... Status: 200 OK"
