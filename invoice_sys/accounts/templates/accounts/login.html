<form id="loginForm">
  <input type="text" id="username" placeholder="Username" required /><br/>
  <input type="password" id="password" placeholder="Password" required /><br/>
  <button type="submit">Login</button>
</form>
<p id="msg"></p>

<script>
   // ✅ لو فيه توكن موجود بالفعل، ممنوع يدخل صفحة login
  if (localStorage.getItem("access")) {
    console.log("Already logged in, redirecting...");
    window.location.href = "/invoices/";
  }

  // ✅ تأكد إن الصفحة دي ما تتخزنش في الكاش
  if ('caches' in window) {
    caches.keys().then(function(names) {
      for (let name of names) caches.delete(name);
    });
  }
  const loginForm = document.getElementById("loginForm");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    // 1️⃣ تسجيل الدخول
    const res = await fetch("/api/accounts/token/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: document.getElementById("username").value,
        password: document.getElementById("password").value,
      }),
    });

    if (!res.ok) {
      const data = await res.json();
      document.getElementById("msg").textContent = JSON.stringify(data);
      return;
    }

    // 2️⃣ حفظ التوكينز
    const data = await res.json();
    localStorage.setItem("access", data.access);
    localStorage.setItem("refresh", data.refresh);

    // 3️⃣ جلب بيانات المستخدم
    const userRes = await fetch("/api/accounts/me/", {
      headers: { Authorization: `Bearer ${data.access}` },
    });

    if (userRes.ok) {
      const user = await userRes.json();

      console.log("User data:", user);

      // 4️⃣ تحديد الـ redirect على حسب الدور
      if (user.role === "sales" || user.role === "manager") {
        window.location.href = "/invoices/";
      } else if (user.role === "owner") {
        window.location.href = "/clients/";
      } else {
        alert("Unknown role: " + user.role);
      }
    } else {
      alert("Failed to fetch user info");
    }
  });
</script>
